<!-- /templates/fragments/chatbot.html -->
<div th:fragment="chatbot-modal">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#chatModal" data-project-id="{projectId}"
        onclick="openChat(this)">
        Quick Review
    </button>

    <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true"
        data-bs-backdrop="static" data-bs-keyboard="false">
        <!-- thêm class "modal-dialog-centered" để căn giữa -->
        <div class="modal-dialog modal-xl modal-dialog-centered animate-slide">
            <div class="modal-content shadow-lg rounded-3">
                <div class="modal-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="modal-title" id="chatModalLabel">Chatbot</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <!-- tin nhắn  -->
                    <div id="chatMessages" class="border p-2"
                        style="height: 480px; overflow-y: auto; background: #f8f9fa;">
                    </div>

                    <!-- input và nút gửi -->
                    <div class="mt-2 d-flex flex-row align-items-center gap-2">
                        <input type="text" id="chatInput" class="form-control" placeholder="Ask something...">
                        <button class="btn btn-success ml-2" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Hiệu ứng trượt nhẹ từ dưới lên */
        .animate-slide {
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.4s ease-out;
        }

        .modal.show .animate-slide {
            transform: translateY(0);
            opacity: 1;
        }

        /* Giao diện tin nhắn */
        .message {
            margin: 6px 0;
            padding: 10px 14px;
            border-radius: 15px;
            max-width: 75%;
            word-wrap: break-word;
        }

        .user-message {
            background-color: #198754;
            color: white;
            align-self: flex-end;
            text-align: right;
            margin-left: auto;
        }

        .bot-message {
            background-color: white;
            color: #198754;
            border: 1px solid #198754;
            align-self: flex-start;
            text-align: left;
            margin-right: auto;
        }

        #chatMessages {
            display: flex;
            flex-direction: column;
            font-size: 14px;
            border-radius: 6px;
            scroll-behavior: smooth;
        }

        .modal-content {
            border: none;
        }

        .modal-header {
            border-bottom: 2px solid #198754;
        }

        .btn-success {
            min-width: 70px;
        }

        .chat-message.bot {
            display: flex;
            justify-content: flex-start;
        }

        .chat-message.bot .message-bubble {
            background-color: #f1f0f0;
            color: #333;
            border-radius: 15px 15px 15px 0;
            padding: 10px 15px;
            max-width: 70%;
            word-wrap: break-word;
            animation: fadeIn 0.2s ease-in;
        }

        .chat-message.user {
            display: flex;
            justify-content: flex-end;
        }

        .chat-message.user .message-bubble {
            background-color: #0d6efd;
            color: white;
            border-radius: 15px 15px 0 15px;
            padding: 10px 15px;
            max-width: 70%;
            word-wrap: break-word;
            animation: fadeIn 0.2s ease-in;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentProjectId = null;
        const initMessage = "Summarize the project status";

        openChat = (button) => {
            const projectId = button.getAttribute("data-project-id");
            console.log("Open chat for project ID:", projectId);
            // Bạn có thể sử dụng projectId để tải dữ liệu liên quan nếu cần
            sendAutoMessage(initMessage);
        };

        async function sendAutoMessage(message) {
            appendMessage("user", message);

            const response = await fetch("/chat/send", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ message: message })
            });

            const history = await response.json();
            const last = history[history.length - 1];
            appendMessage(last.sender, last.content);
        }

        async function sendMessage() {
            const input = document.getElementById("chatInput");
            const messages = input.value.trim();
            if (!messages || !currentProjectId) return;
            appendMessage("user", messages);
            input.value = "";
            // Gửi tin nhắn đến server
            const response = await fetch("/chat/send", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ message: messages, projectId: currentProjectId })
            })
                .then(res => res.json())
                .then(history => {
                    const last = history[history.length - 1];
                    appendMessage(last.sender, last.content);
                })
                .catch(err => console.error("Error:", err));

        }

        function appendMessage(sender, content) {
            const chatMessages = document.getElementById("chatMessages");
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message");
            messageDiv.className = `chat-mesage.${sender}`;
            messageDiv.innerHTML = `<div class="message-bubble">${content}</div>`;
            messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Tự động cuộn xuống dưới
        }
    </script>
</div>